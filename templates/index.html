<!-- ...header & chatbox sebelumnya tetap... -->
<form id="input-form" enctype="multipart/form-data">
  <input type="text" id="user-input" placeholder="Ketik pertanyaan Anda..." required />
  <label for="file-upload" style="cursor:pointer; color: maroon;">📎</label>
  <input type="file" id="file-upload" accept=".pdf,.jpg,.jpeg,.png" style="display:none" />
  <button type="submit">Kirim</button>
</form>

<div id="file-preview" style="text-align:center; margin-top:10px;"></div>

<script>
const form = document.getElementById('input-form');
const input = document.getElementById('user-input');
const fileInput = document.getElementById('file-upload');
const preview = document.getElementById('file-preview');
const chatBox = document.getElementById('chat-box');

let uploadedFileContent = "";

form.onsubmit = async (e) => {
  e.preventDefault();
  const userText = input.value;
  appendMessage(userText, 'user');
  input.value = "";
  appendMessage("Sedang mengetik...", 'bot');

  const message = uploadedFileContent
    ? `${userText}\n\nBerikut adalah konten file yang saya unggah:\n${uploadedFileContent}`
    : userText;

  uploadedFileContent = "";
  preview.innerHTML = "";

  const res = await fetch('/api/chat', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({message})
  });

  const data = await res.json();
  document.querySelectorAll('.bot:last-child')[0].remove();
  appendMessage(data.reply || '[Terjadi kesalahan]', 'bot');
};

fileInput.addEventListener('change', async () => {
  const file = fileInput.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append('file', file);

  const res = await fetch('/api/upload', {
    method: 'POST',
    body: formData
  });

  const data = await res.json();
  if (data.type === "pdf") {
    uploadedFileContent = data.content;
    preview.innerHTML = `<p style="color:#aaa;">📄 PDF berhasil diunggah dan dibaca</p>`;
  } else if (data.type === "image") {
    uploadedFileContent = "[Gambar telah diunggah]";
    preview.innerHTML = `<img src="${data.content}" alt="Preview" style="max-width:200px; margin:10px auto; border:1px solid #444"/>`;
  } else {
    preview.innerHTML = `<p style="color:red;">❌ Gagal memproses file</p>`;
  }
});

function appendMessage(content, sender) {
  const div = document.createElement('div');
  div.className = `msg ${sender}`;
  div.innerHTML = content + `<span class="copy-btn" onclick="copyToClipboard(this)">📋</span>`;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function copyToClipboard(el) {
  const text = el.parentElement.textContent;
  navigator.clipboard.writeText(text.trim());
  el.textContent = "✅";
  setTimeout(() => el.textContent = "📋", 1500);
}
</script>